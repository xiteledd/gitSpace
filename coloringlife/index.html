<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=yes" />
	<title>coloring life</title>
	<script src="phaser.min.js"></script>
	<style type="text/css">
		@media all and (orientation:landscape);
	</style>
</head>
<body>
	<div id="game-canvas"></div>
	<script type="text/javascript">
		//dimension
		var gameWidth = 376;//376
		var gameHeight = 724;//724
		var beginX = gameWidth*0.05;
		var beginY = gameHeight*0.15;
		var cellwidth = 15;
		var totalRow = 19;
		var totalCol = 23;

		//UI
		var PaintLayer;//绘制层组
		var currentColor;
		var rect;

		//data
		var markNum;
		var colorType;
		var isTouch;
		var colorIdx = [
			[0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0],
			[0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
			[0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,0],
			[1,1,1,0,2,2,2,1,1,1,0,0,0,1,1,1,2,2,2,1,1,1,1],
			[1,1,0,2,2,2,2,2,1,1,1,0,1,1,1,2,2,2,2,2,1,1,1],
			[1,1,0,2,2,0,2,2,2,1,1,1,1,1,2,2,2,2,2,2,2,1,1],
			[1,1,2,2,0,3,3,2,2,2,1,1,1,2,2,2,3,3,2,2,2,1,1],
			[1,1,1,2,2,3,3,3,2,2,2,1,2,2,2,3,3,3,2,2,1,1,1],
			[0,1,1,1,2,2,3,3,3,3,2,2,2,3,3,3,3,2,2,1,1,1,0],
			[0,0,1,1,1,2,2,3,3,3,3,2,3,3,3,3,2,2,1,1,1,0,0],
			[0,0,0,1,1,1,2,2,3,3,3,3,3,3,3,2,2,1,1,1,0,0,0],
			[0,0,0,0,1,1,1,2,2,3,3,3,3,3,2,2,1,1,1,0,0,0,0],
			[0,0,0,0,0,1,1,1,2,2,3,3,3,2,2,1,1,1,0,0,0,0,0],
			[0,0,0,0,0,0,1,1,1,2,2,3,2,2,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,1,1,1,2,2,2,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,1,1,1,2,1,1,1,0,0,0,0,0,0,0,0],		
			[0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
		];
		var state = [     //状态数组，0:无色不可涂,1:有色不可涂,2:可涂,3:正确颜色不可再涂 4:错误颜色，不可再涂相同颜色，可覆盖其他颜色
			[0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0],
			[0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0],
			[0,1,1,1,0,0,1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,0],
			[1,1,1,0,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1],
			[1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],
			[1,1,0,1,1,0,1,2,2,2,1,1,1,2,2,2,1,1,1,1,1,1,1],
			[1,1,1,1,0,1,2,2,2,2,2,1,2,2,2,2,2,1,1,1,1,1,1],
			[1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1],
			[0,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,0],
			[0,0,1,1,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,1,1,0,0],
			[0,0,0,1,1,1,1,1,2,2,2,2,2,2,2,1,1,1,1,1,0,0,0],
			[0,0,0,0,1,1,1,1,1,2,2,2,2,2,1,1,1,1,1,0,0,0,0],
			[0,0,0,0,0,1,1,1,1,1,2,2,2,1,1,1,1,1,0,0,0,0,0],
			[0,0,0,0,0,0,1,1,1,1,1,2,1,1,1,1,1,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
		];
		var result = [
			[0,0,0,0,7,7,7,0,0,0,0,0,0,0,0,0,7,7,7,0,0,0,0],
			[0,0,7,7,7,7,7,7,0,0,0,0,0,0,0,7,7,7,7,7,7,0,0],
			[0,7,7,7,0,0,7,7,7,0,0,0,0,0,7,7,7,7,7,7,7,7,0],
			[7,7,7,0,8,8,8,7,7,7,0,0,0,7,7,7,8,8,8,7,7,7,7],
			[7,7,0,8,8,8,8,8,7,7,7,0,7,7,7,8,8,8,8,8,7,7,7],
			[7,7,0,8,8,0,8,8,8,7,7,7,7,7,8,8,8,8,8,8,8,7,7],
			[7,7,8,8,0,9,9,8,8,8,7,7,7,8,8,8,9,9,8,8,8,7,7],
			[7,7,7,8,8,9,9,9,8,8,8,7,8,8,8,9,9,9,8,8,7,7,7],
			[0,7,7,7,8,8,9,9,9,9,8,8,8,9,9,9,9,8,8,7,7,7,0],
			[0,0,7,7,7,8,8,9,9,9,9,8,9,9,9,9,8,8,7,7,7,0,0],
			[0,0,0,7,7,7,8,8,9,9,9,9,9,9,9,8,8,7,7,7,0,0,0],
			[0,0,0,0,7,7,7,8,8,9,9,9,9,9,8,8,7,7,7,0,0,0,0],
			[0,0,0,0,0,7,7,7,8,8,9,9,9,8,8,7,7,7,0,0,0,0,0],
			[0,0,0,0,0,0,7,7,7,8,8,9,8,8,7,7,7,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,7,7,7,8,8,8,7,7,7,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,7,7,7,8,7,7,7,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,7,7,7,7,7,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,7,7,7,0,0,0,0,0,0,0,0,0,0],
			[0,0,0,0,0,0,0,0,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0]
		];

		var colorArray = {
			0:0xffffff,//白
			1:0x979797,//外灰
			2:0xb2b2b2,//中灰
			3:0xcacaca,//内灰
			4:0xa6a6a6,//外高亮
			5:0xc3c3c3,//中高亮
			6:0xe2e2e2,//内高亮
			7:0xf14058,//外红
			8:0xf67082,//中红
			9:0xf99aa7,//内红
			10:0x565656
		};


		window.onload = function(){
			var game = new Phaser.Game(gameWidth,gameHeight,Phaser.AUTO,'game-canvas',
				{preload:preload,create:create,update:update});

			// console.log(document.body.clientWidth​,window.devicePixelRatio);
			// //画布重新布局
			window.onresize=function(){
				game.scale.setGameSize(document.body.clientWidth*window.devicePixelRatio,document.body.clientHeight*window.devicePixelRatio);
				game.scale.refresh();
			};

			function preload(){
				game.load.image('num0','num0.png');
				game.load.image('num1','num1.png');
				game.load.image('num2','num2.png');
			}


			function create(){
				this.scale.scaleMode = Phaser.ScaleManager.SHOW_ALL;//确保游戏给定符合的尺寸
				this.scale.pagealignhorizontally = true;
				this.scale.pagealignvertically = true;

				game.stage.backgroundColor = '#ffffff';
				PaintLayer = game.add.group();
				initUI();
				
			
				game.input.onDown.add(function(pointer){
					// moveToPaint(pointer.x,pointer.y);
					isTouch = true;
				});

				game.input.onUp.add(function(){
					isTouch = false;
				});

				game.input.addMoveCallback(function(pointer,x,y,isTap){
					if(isTouch){
						moveToPaint(pointer.x,pointer.y);
					}
				});
			}

			function update(){

			}

			function initUI(){
				freshDrawBoard(1);
				createPalette(beginX,gameHeight*0.7);

			}

			function RcToXy(row,col){
				var tempx,tempy;
				if(row!==undefined&&col!==undefined
					&&0<=row&&row<totalRow
					&&0<=col&&col<totalCol){
					tempx = beginX+col*cellwidth;
					tempy = beginY+row*cellwidth;
				}
				return{
					x:tempx,
					y:tempy
				};
			}

			//坐标转换,x坐标转换成列，y坐标转换成行
			function transX(x){
				var tempcol;
				if(beginX<x&&x<beginX+totalCol*cellwidth){
					tempcol = Math.floor((x-beginX)/cellwidth);
					return tempcol;
				}
			}	

			//返回行
			function transY(y){
				var temprow;
				if(beginY<y&&y<beginY+totalRow*cellwidth){
					temprow = Math.floor((y-beginY)/cellwidth);
					return temprow;
				}
			}

			//格子
			function creategrid(){
				var s_XH,s_YH,e_XH,s_XV,s_YV,e_YV;
				var isFirst_h = false;
				var line = game.add.graphics(beginX-cellwidth-10,beginY-110);
				line.z = 0;
				PaintLayer.addChild(line);
				//水平线分两步
				for(let i=0;i<totalRow;i++){
					isFirst_h = false;
					for(let j=0;j<totalCol;j++){
						if(state[i][j]!==0){
							if(!isFirst_h){
								s_XH = RcToXy(i,j).x;
								s_YH = RcToXy(i,j).y;
								isFirst_h = true;
							}
						}else{
							if(j>Math.floor(totalCol/2)){
								e_XH = RcToXy(i,j).x;
								break;	
							}
						}
					}
					line.lineStyle(1,0x9e7b48,0.5);
					line.moveTo(s_XH,s_YH);
					line.lineTo(e_XH,s_YH);
				}


				//垂直线
				for(let i=0;i<totalCol;i++){
					isFirst_h = false;
					for(let j=0;j<totalRow;j++){
						//每次分别计算开始位置和结束位置
						if(state[j][i]!==0){
							if(!isFirst_h){
								s_XV = RcToXy(j,i).x;
								s_YV = RcToXy(j,i).y;
								isFirst_h = true;
							}
						}else if(j>Math.floor(totalRow/2)){
								e_YV = RcToXy(j+1,i).y;
								break;
							}
						}
					line.lineStyle(1,0x9e7b48,0.5);
					line.moveTo(s_XV,s_YV);
					line.lineTo(s_XV,e_YV);	
				}
			}

			//颜色选择
			function createPalette(x,y){
				let scale_btn = 0.2
				for(let i=0;i<3;i++){
					var btn_select = game.add.sprite(x+i*200*scale_btn*2,y,'num'+i);
					PaintLayer.addChild(btn_select);
					btn_select.scale.set(scale_btn);
					btn_select.inputEnabled = true;
					btn_select.events.onInputDown.add(function(){
						currentColor = i+1+2*3;
						freshDrawBoard(2);
					},this);
				}
			}

			function paint(row,col,color){
				if(row!==undefined&&col!==undefined&&0<=row&&row<=totalRow
					&&0<=col&&col<=totalCol&&color!==undefined){
					let tempx = RcToXy(row,col).x;
					let tempy = RcToXy(row,col).y;
					rect  = game.add.graphics();
					rect.z = 0;
					PaintLayer.addChild(rect);
					//先刷新之前的颜色
					rect.beginFill(colorArray[0]);
					rect.drawRect(tempx,tempy,cellwidth,cellwidth);
					rect.endFill();

					if((state[row][col]===2&&state[row][col]===4)
						||result[row][col]!==color){
							rect.beginFill(colorArray[color],0.5);
					}else{
						rect.beginFill(colorArray[color]);
					}
					rect.drawRect(tempx,tempy,cellwidth,cellwidth);
					rect.endFill();
				}

			}

			function addNumber(row,col,num){
				if(row!==undefined&&col!==undefined&&0<=row&&row<=totalRow
					&&0<=col&&col<=totalCol&&num!==undefined&&num!==0){
					let x = RcToXy(row,col).x + cellwidth/2;
					let y = RcToXy(row,col).y + cellwidth/2;
					let style ={font: cellwidth+"px SimHei", fill: "#000000", align: "center"};
					let text = game.add.text(x,y,num,style);
					PaintLayer.addChild(text);
					text.z = 0;
					text.anchor.set(0.5);
					text.scale.set(0.65)
				}
			}

			function freshDrawBoard(step){
				for(let i=0;i<totalRow;i++){
					for(let j=0;j<totalCol;j++){
						switch(step){
							case 1:
								prePaint(i,j,state[i][j]);
								// creategrid();
								break;
							case 2:
								highLight(i,j,currentColor);
								break;
							default:
								break;
						}
					}
				}
			}

			//预绘制
			function prePaint(row,col,idx){
				if(row!=undefined&&col!==undefined&&idx!==0){
					switch(idx){
						case 1:
							//预填充一部分
							paint(row,col,result[row][col]);
							state[row][col] = 3;
							break;
						case 2:
							paint(row,col,result[row][col]-6);
							addNumber(row,col,result[row][col]-6);
							break;
						default:
							break;
					}
				}
			}

			//高亮
			function highLight(row,col,color){
				var idx = judgeCanPaint(row,col,color);
				if(idx===1){
					if(result[row][col]===color)
						paint(row,col,10);
					else if(result[row][col]!==color)
						paint(row,col,result[row][col]-6);

					addNumber(row,col,result[row][col]-6);
				}
			}

			//填充
			function selectPaint(row,col,color){
				var cell_state = judgeCanPaint(row,col,color);
				if(cell_state!==0&&cell_state!==undefined){
					switch(cell_state){
						case 1:   //初始未填充
							paint(row,col,color);
							changeState(row,col,color);
							break;
						case 2: 	//初始为错误填充
							paint(row,col,color);
							changeState(row,col,color);
							break;
						default:
							break;
					}
				}
			}

			//判断是否可涂
			function judgeCanPaint(row,col,color){
				if (row!==undefined&&col!==undefined&&color!==undefined){
					if(state[row][col]===0||state[row][col]===1||state[row][col]===3){
						return 0;   
					}else if(state[row][col]===2){
						return 1;
					}else if(state[row][col]===4&&color!==colorIdx[row][col]){  //state为4的状态是可涂，但不能以现在该区域当前颜色涂
						return 2;
					}
				}
			}

			//更新状态
			function changeState(row,col,color){
				if(state[row][col]===0||state[row][col]===1){
					return;
				}
				if(color===result[row][col]){
					state[row][col] =3;
					colorIdx[row][col] = color;
				}else{
					state[row][col] = 4;
					colorIdx[row][col] = color;
					addNumber(row,col,result[row][col]-6);
				}
			}

			function moveToPaint(x,y){
				var tmpRow = transY(y);
				var tmpCol = transX(x);
				selectPaint(tmpRow,tmpCol,currentColor);
			}

			function checkSuccess(){
				var successCount = 0;
				var count = 0;
				for(let i=0;i<totalRow;i++){
					for(let j=0;j<totalCol;j++){
						if(state[i][j]!==0){
							count ++;
							if(colorIdx[i][j]===result[i][j])
								successCount++;
						}
					}
				}
				return successCount===count? true:false;
			}


			function PopLayer(){
				
			}
		}
	</script>
</body>
</html>



<!--   
                           _ooOoo_
                          o8888888o
                          88" . "88
                          (| -_- |)
                          O\  =  /O
                       ____/`---'\____
                     .'  \\|     |//  `.
                    /  \\|||  :  |||//  \
                   /  _||||| -:- |||||-  \
                   |   | \\\  -  /// |   |
                   | \_|  ''\---/''  |   |
                   \  .-\__  `-`  ___/-. /
                 ___`. .'  /--.--\  `. . __
              ."" '<  `.___\_<|>_/___.'  >'"".
             | | :  `- \`.;`\ _ /`;.`/ - ` : | |
             \  \ `-.   \_ __\ /__ _/   .-` /  /
        ======`-.____`-.___\_____/___.-`____.-'======
                           `=---='
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
                 佛祖保佑       永无BUG 
 -->